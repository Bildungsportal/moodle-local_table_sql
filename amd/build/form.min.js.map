{"version":3,"file":"form.min.js","sources":["../src/form.js"],"sourcesContent":["/* eslint-disable */\nimport $ from 'jquery';\nimport ModalFactory from 'core/modal_factory';\nimport ModalEvents from 'core/modal_events';\nimport Notification from 'core/notification';\nimport {get_strings} from 'core/str';\n\nvar debug = false;\n\n\nasync function xhrRequest(xhrdata) {\n  let ret;\n  try {\n    ret = await $.post(document.location.href, xhrdata);\n  } catch (e) {\n    var error = '';\n\n    // if the error is a html output get the error from the html code\n    if (e.responseText && typeof e.responseText == 'string' && e.responseText[0] === '<') {\n      error = $(e.responseText).find('.errormessage').text();\n    }\n\n    if (!error) {\n      error = 'Unknown error!';\n    }\n\n    Notification.exception(new Error(error));\n\n    throw e;\n  }\n\n  if (ret.error) {\n    if (ret.exception) {\n      Notification.exception(ret.exception);\n\n      // TODO: like this?\n      throw ret.exception;\n    } else {\n      alert(ret.error);\n\n      // TODO: like this?\n      throw ret;\n    }\n  } else {\n    return ret;\n  }\n}\n\n/**\n * load the form into a modal by use of ajax.\n * @param {DOMobject} sender\n * @param {object} modaldata\n */\nexport async function loadModal(sender, modaldata = null) {\n  const $pane = $(sender).closest('.table-sql-modal');\n  modaldata = modaldata || $pane.data('modaldata');\n\n  const xhrdata = {\n    ...modaldata.xhrdata,\n    is_xhr: 1,\n    table_sql_action: 'form_show'\n  };\n\n  if (debug) {\n    console.log('Loading modal for params', xhrdata);\n  }\n\n  var response = await xhrRequest(xhrdata);\n\n  ModalFactory.create({\n    // body gets set in updateModal()\n    body: '', // response.form,\n    large: true,\n    removeOnClose: true,\n    title: response.modal_title,\n    type: ModalFactory.types.SAVE_CANCEL,\n  }).then(function (modal) {\n    updateModal(modaldata, modal, response, $pane);\n    modal.show();\n    modal.getRoot().on(ModalEvents.save, (e) => {\n      e.preventDefault();\n      send(modaldata, modal, $pane);\n    });\n\n    // TODO: on cancel remove modal?!?\n  });\n}\n\n/**\n * Update modal if a form was loaded into it.\n * @param {object} modaldata\n * @param {object} modal\n * @param {object} response\n * @param {DOMobject} pane\n */\nfunction updateModal(modaldata, modal, response, $pane) {\n  $(modal.getRoot()).find('.modal-body').html(response.form);\n\n  // set default values\n  for (const [key, value] of Object.entries(modaldata.values || [])) {\n    $(modal.getRoot()).find('input[type=\"text\"], select, textarea').filter('[name=\\\"' + key + '\\\"], select[name=\\\"' + key + '\\\"]').val(value);\n    $(modal.getRoot()).find('radio[name=\\\"' + key + '\\\"][value=\\\"' + value + '\\\"').prop('checked', true);\n  }\n\n  let showfields = modaldata.showfields;\n\n  let $form = $(modal.getRoot()).find('form');\n\n  // only show the field of the current column\n  // if (showfields && showfields.length == 0) {\n  //   // Find the closest element and filter for the class starting with 'local_table_sql-column-'\n  //   var closestNode = $pane.closest('[class*=\"local_table_sql-column-\"]');\n  //\n  //   // Extract the column name by matching the class pattern\n  //   var columnName = closestNode.attr('class')?.match(/local_table_sql-column-(\\S+)/)?.[1];\n  //\n  //   if (columnName) {\n  //     if ($form.find('input[name=\"' + columnName + '\"]').length) {\n  //       // column exists, hide all others\n  //       showfields = [columnName];\n  //     }\n  //   }\n  // }\n\n  if (showfields && showfields.length > 0) {\n    $form.find('[name]').each(function () {\n      let name = $(this).attr('name');\n      if (showfields.indexOf(name) === -1) {\n        $(this).closest('.row')\n          .not('.has-danger') // bei einem Fehler dieses Feld nicht ausblenden\n          .addClass('hidden');\n      }\n    });\n  }\n\n  // remove the button row\n  $form.find('#id_submitbutton').closest('.row').remove();\n  // add own submit, so the form can get submitted\n  $form.append('<input type=\"submit\"  class=\"hidden\"/>');\n  $form.submit(function (e) {\n    // prevent submit post\n    e.preventDefault();\n\n    // trigger modal event\n    modal.getRoot().trigger(ModalEvents.save);\n  });\n\n  // Run any required javascript.\n  if (response.pageendcode) {\n    let script = $('<script>').data('added', Date.now()).html(response.pageendcode);\n    if (debug) {\n      console.log('appending page end code', script);\n    }\n    $('body').append(script);\n  }\n}\n\n/**\n * Actually send the data. Depending on the result. update the form or close the modal and update the cell.\n * @param {object} modaldata\n * @param {object} modal\n * @param {DOMobject} $pane\n *\n *\n */\nasync function send(modaldata, modal, $pane) {\n  let form = $(modal.getRoot()).find('form');\n\n  const xhrdata = {\n    ...modaldata.xhrdata,\n    ...$(form).serializeArray().reduce(function (obj, item) {\n      // for arrays (multiselect etc.) use an array\n      if (item.name.match(/\\[\\]$/)) {\n        if (!obj[item.name]) {\n          obj[item.name] = [];\n        }\n        obj[item.name].push(item.value);\n      } else {\n        obj[item.name] = item.value;\n      }\n\n      return obj;\n    }, {}),\n    is_xhr: 1,\n    table_sql_action: 'form_save'\n  };\n  if (debug) {\n    console.log('Store row', xhrdata);\n  }\n\n  var response = await xhrRequest(xhrdata);\n  if (debug) {\n    console.log('Response', response);\n  }\n\n  if (response.form) {\n    // there was an error, show form again\n    updateModal(modaldata, modal, response, $pane);\n    return;\n  }\n\n  // remove the modal content (the form), so it doesn't trigger any \"do you want to save?\" alerts\n  $(modal.getRoot()).find('.modal-body').html('');\n\n  if ($pane.length && response.colreplace) {\n    // replacing single value in table\n    $pane.replaceWith($(response.colreplace));\n  } else {\n    // reload the table\n    window.table_sql_reload();\n  }\n\n  modal.hide();\n}\n\nexport async function deleteRow(event, row) {\n  const [\n    str_confirmdeleterecord\n  ] = await get_strings([\n    {\n      key: 'confirmdeleterecord',\n      component: 'local_table_sql'\n    }\n  ]);\n\n  if (!confirm(str_confirmdeleterecord)) {\n    return;\n  }\n\n  console.log(row);\n\n  const xhrdata = {\n    rowid: row.original.id,\n    is_xhr: 1,\n    table_sql_action: 'delete_row'\n  };\n\n  await xhrRequest(xhrdata);\n\n  window.table_sql_reload();\n}\n"],"names":["event","row","str_confirmdeleterecord","key","component","confirm","console","log","xhrdata","rowid","original","id","is_xhr","table_sql_action","xhrRequest","window","table_sql_reload","sender","modaldata","$pane","closest","data","response","create","body","large","removeOnClose","title","modal_title","type","ModalFactory","types","SAVE_CANCEL","then","modal","updateModal","show","getRoot","on","ModalEvents","save","e","preventDefault","send","ret","$","post","document","location","href","error","responseText","find","text","exception","Error","alert","html","form","value","Object","entries","values","filter","val","prop","showfields","$form","length","each","name","this","attr","indexOf","not","addClass","remove","append","submit","trigger","pageendcode","script","Date","now","serializeArray","reduce","obj","item","match","push","colreplace","replaceWith","hide"],"mappings":"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"}